# Implementation Plan: Homebrew Formula

## Summary

Create a Homebrew formula so klartex can be installed via `brew install swedev/tap/klartex`. The formula will live in a custom tap repository (`swedev/homebrew-tap`), install klartex from PyPI into a Homebrew-managed virtualenv, and document xelatex as a required runtime dependency.

## Triage Info

> Decision-support metadata for this issue.

| Field | Value |
|-------|-------|
| **Blocked by** | #2 Publish to PyPI (open) |
| **Blocks** | None |
| **Related issues** | #4 Docker image (alternative distribution, also modifies READMEs) |
| **Scope** | 1 new repo + 1 formula file + 2 README edits |
| **Risk** | Low |
| **Complexity** | Low |
| **Safe for junior** | Yes |
| **Conflict risk** | Medium (README.md and README.en.md also touched by #4 Docker image plan) |
| **External dependencies** | PyPI package published (#2), swedev org admin access for tap repo, `homebrew-pypi-poet` or `brew update-python-resources` tool |

### Triage Notes

This issue is **blocked by #2** (Publish to PyPI). The Homebrew formula needs to reference a published PyPI package with a stable URL and SHA256 checksum. Until klartex is available on PyPI, the formula cannot be finalized or tested.

Once #2 is resolved, this issue can proceed immediately. The plan below is complete and ready to execute once the PyPI package exists.

**Conflict note:** Issue #4 (Docker image) also plans to modify `README.md` and `README.en.md`. Coordinate README edits to avoid merge conflicts -- whichever lands second should rebase.

## Analysis

Homebrew formulas for Python packages typically use the `resource` pattern to install from PyPI, or use a `url` pointing to the PyPI sdist tarball. Since klartex is a Python CLI tool with a `pyproject.toml` using hatchling, the formula should:

1. Download the sdist from PyPI
2. Install into a Python virtualenv managed by Homebrew
3. Document that xelatex is a runtime requirement (TeX Live cannot be a Homebrew dependency directly since it uses `--cask mactex`)

Key considerations:
- klartex requires Python >= 3.13
- klartex has 6 runtime dependencies (fastapi, uvicorn, jinja2, pyyaml, jsonschema, typer)
- xelatex is a runtime requirement but not installable via Homebrew core formulas (it requires `brew install --cask mactex`)
- The formula will live in a custom tap (`swedev/tap`)
- The renderer resolves `templates/`, `cls/`, and `branding/` relative to the package root via `Path(__file__).resolve().parent.parent` -- verify these assets are included in the PyPI sdist

## Implementation Steps

### Phase 1: Create Homebrew tap repository

1. Create a new GitHub repository `swedev/homebrew-tap`
   - This is the standard naming convention for Homebrew taps
   - Users will tap it with `brew tap swedev/tap`
   - Requires swedev org admin access

### Phase 2: Create formula skeleton

1. Create `Formula/klartex.rb` in the tap repository with the basic structure:
   - Use Homebrew's Python formula pattern with `Language::Python::Virtualenv`
   - Set `depends_on "python@3.13"`
   - Add a `caveats` block for the xelatex requirement (keep it concise)
   - Add a `test` block that verifies both CLI and template discovery
   - Leave placeholder for resource stanzas and URL/SHA
   - Files to create: `Formula/klartex.rb`

### Phase 3: Generate resource stanzas

1. Use `brew update-python-resources` or the `homebrew-pypi-poet` tool to generate resource blocks for all Python dependencies
   - `pip install homebrew-pypi-poet`
   - `poet klartex` (after the package is on PyPI)
   - This generates the correct `resource` blocks with URLs and SHA256 checksums
2. Insert the generated resource blocks into the formula skeleton
3. Set the main `url` and `sha256` to point to the klartex PyPI sdist

### Phase 4: Finalize the formula

1. The completed formula structure:
   ```ruby
   class Klartex < Formula
     include Language::Python::Virtualenv

     desc "PDF generation via LaTeX - structured data in, professional documents out"
     homepage "https://github.com/swedev/klartex"
     url "https://files.pythonhosted.org/packages/source/k/klartex/klartex-{VERSION}.tar.gz"
     sha256 "{SHA256}"
     license "MIT"

     depends_on "python@3.13"

     # resource blocks for each dependency (generated by poet/brew)

     def install
       virtualenv_install_with_resources
     end

     def caveats
       <<~EOS
         klartex requires XeLaTeX to generate PDFs.
         Install it with:
           brew install --cask mactex
         or for a minimal installation:
           brew install --cask basictex
         See the README for required TeX packages.
       EOS
     end

     test do
       assert_match "Usage", shell_output("#{bin}/klartex --help")
       assert_match "protokoll", shell_output("#{bin}/klartex templates")
       assert_match "template", shell_output("#{bin}/klartex schema protokoll")
     end
   end
   ```

### Phase 5: Test the formula

1. Install from the local tap
   ```bash
   brew tap swedev/tap
   brew install swedev/tap/klartex
   ```

2. Verify:
   - `klartex --help` works
   - `klartex templates` lists available templates (confirms packaged assets work)
   - `klartex schema protokoll` returns valid JSON Schema
   - `klartex render` works with xelatex installed
   - `brew test swedev/tap/klartex` passes
   - `brew audit --strict swedev/tap/klartex` passes

### Phase 6: Document installation

1. Update `README.md` to add Homebrew installation option (Swedish)
   - Add after existing `pip install klartex` section
   - Show: `brew install swedev/tap/klartex`
   - Files to modify: `README.md`

2. Update `README.en.md` with the same section (English)
   - Files to modify: `README.en.md`

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `swedev/homebrew-tap` (new repo) | Create | Homebrew tap repository |
| `Formula/klartex.rb` (in tap repo) | Create | Homebrew formula for klartex |
| `README.md` (klartex repo) | Modify | Add Homebrew installation instructions |
| `README.en.md` (klartex repo) | Modify | Add Homebrew installation instructions (English) |

## Codebase Areas

- `swedev/homebrew-tap` (new repository)
- Project root (`README.md`, `README.en.md`)

## Design Decisions

> Non-trivial choices made during planning. Feedback welcome; otherwise implementation proceeds with these.

### 1. Custom tap over homebrew-core submission
**Options:** (A) Submit to homebrew-core vs (B) Create `swedev/homebrew-tap`
**Decision:** B -- Custom tap
**Rationale:** homebrew-core has strict acceptance criteria (notable projects, many users). A custom tap is appropriate for a new project and gives full control over updates. Can always submit to homebrew-core later if the project gains traction.

### 2. Caveats for xelatex instead of hard dependency
**Options:** (A) Attempt to depend on mactex cask vs (B) Document xelatex requirement in caveats
**Decision:** B -- Caveats
**Rationale:** Homebrew core formulas cannot depend on casks. The formula should install cleanly and inform the user about the xelatex requirement via `brew info klartex` caveats. This is the standard pattern for tools with external runtime dependencies. Keep caveats concise; detailed TeX package lists go in the README.

### 3. virtualenv_install_with_resources pattern
**Options:** (A) Simple pip install vs (B) Homebrew's virtualenv pattern with resource stanzas
**Decision:** B -- virtualenv with resources
**Rationale:** This is the standard Homebrew pattern for Python packages. It creates an isolated virtualenv, pins all dependencies with SHA256 checksums, and integrates with Homebrew's dependency management. Much more reliable than a bare pip install.

### 4. Stronger formula test block
**Options:** (A) Only test `--help` vs (B) Test `--help`, `templates`, and `schema`
**Decision:** B -- Multiple functional tests
**Rationale:** The `templates` command exercises the template registry and confirms non-code assets (templates/, cls/) are correctly packaged. The `schema` command confirms JSON Schema files are accessible. These catch packaging issues that `--help` alone would miss.

## Verification Checklist

- [ ] Formula installs successfully via `brew install swedev/tap/klartex`
- [ ] `klartex --help` works after installation
- [ ] `klartex templates` lists available templates (confirms assets are packaged)
- [ ] `klartex schema protokoll` returns valid JSON Schema
- [ ] `brew test swedev/tap/klartex` passes
- [ ] Caveats mention xelatex requirement and installation instructions
- [ ] All Python dependencies are included as resource stanzas with correct SHA256
- [ ] Formula specifies `depends_on "python@3.13"`
- [ ] README.md updated with Homebrew installation option
- [ ] README.en.md updated with Homebrew installation option
- [ ] `brew audit --strict swedev/tap/klartex` passes (no lint warnings)
- [ ] PyPI sdist includes `templates/`, `cls/`, and `branding/` directories
